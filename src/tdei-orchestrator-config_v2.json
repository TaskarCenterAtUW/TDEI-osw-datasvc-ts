{
    "workflows": [
        {
            "name": "osw_upload",
            "description": "Workflow for uploading osw files",
            "workflow_input": {
                "user_id": "${user_id}",
                "tdei_project_group_id": "${tdei_project_group_id}",
                "dataset_url": "${dataset_url}",
                "metadata_url": "${metadata_url}",
                "changeset_url": "${changeset_url}",
                "latest_dataset_url": "${latest_dataset_url}",
                "tdei_dataset_id": "${tdei_dataset_id}"
            },
            "tasks": [
                {
                    "name": "osw_validation",
                    "task_reference_name": "osw_validation",
                    "description": "Validate the uploaded osw file",
                    "type": "Event",
                    "topic": "temp-request",
                    "input_params": {
                        "user_id": "${workflow_input.user_id}",
                        "tdei_project_group_id": "${workflow_input.tdei_project_group_id}",
                        "file_upload_path": "${workflow_input.dataset_url}"
                    },
                    "output_params": {
                        "success": "${data.success}",
                        "message": "${data.message}"
                    }
                },
                {
                    "name": "osw_osm_formatting",
                    "task_reference_name": "osw_osm_formatting",
                    "description": "Format the validated osw file",
                    "type": "Event",
                    "topic": "temp-request",
                    "input_params": {
                        "user_id": "${workflow_input.user_id}",
                        "tdei_project_group_id": "${workflow_input.tdei_project_group_id}",
                        "file_upload_path": "${workflow_input.dataset_url}"
                    },
                    "output_params": {
                        "success": "${data.success}",
                        "message": "${data.message}",
                        "formatted_url": "${data.formatted_url}"
                    }
                },
                {
                    "name": "decode_url",
                    "task_reference_name": "decode_url",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "url": "${tasks.osw_osm_formatting.output.formatted_url}"
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}",
                        "url": "${url}"
                    },
                    "function": "decode_url"
                },
                {
                    "name": "update_formatted_url",
                    "task_reference_name": "update_formatted_url",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "table": "content.dataset",
                        "where": {
                            "tdei_dataset_id": "${workflow_input.tdei_dataset_id}"
                        },
                        "data": {
                            "osm_url": "${tasks.decode_url.output.url}",
                            "latest_osm_url": "${tasks.decode_url.output.url}"
                        }
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}"
                    },
                    "function": "update_table"
                },
                {
                    "name": "get_osw_osm_dataset_blob_folder_zip_path",
                    "task_reference_name": "get_osw_osm_dataset_blob_folder_zip_path",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "blobUrl": "${workflow_input.dataset_url}",
                        "tdei_dataset_id": "${workflow_input.tdei_dataset_id}"
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}",
                        "osm_output_path": "${osm_output_path}",
                        "osw_output_path": "${osw_output_path}"
                    },
                    "function": "get_osw_osm_dataset_blob_folder_zip_path"
                },
                {
                    "name": "osm_compression",
                    "task_reference_name": "osm_compression",
                    "description": "Compress the uploaded osw file",
                    "type": "Event",
                    "topic": "temp-request",
                    "input_params": {
                        "isOsm": true,
                        "input_urls": [
                            "${tasks.decode_url.output.url}",
                            "${workflow_input.metadata_url}",
                            "${workflow_input.changeset_url}"
                        ],
                        "output_path": "${tasks.get_osw_osm_dataset_blob_folder_zip_path.output.osm_output_path}"
                    },
                    "output_params": {
                        "success": "${data.success}",
                        "message": "${data.message}",
                        "output_path": "${data.output_path}"
                    }
                },
                {
                    "name": "update_osm_db",
                    "task_reference_name": "update_osm_db",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "table": "content.dataset",
                        "where": {
                            "tdei_dataset_id": "${workflow_input.tdei_dataset_id}"
                        },
                        "data": {
                            "dataset_osm_download_url": "${tasks.osm_compression.output.output_path}"
                        }
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}"
                    },
                    "function": "update_table"
                },
                {
                    "name": "osw_compression",
                    "task_reference_name": "osw_compression",
                    "description": "Compress the uploaded osw file",
                    "type": "Event",
                    "topic": "temp-request",
                    "input_params": {
                        "isOsm": false,
                        "input_urls": [
                            "${workflow_input.latest_dataset_url}",
                            "${workflow_input.metadata_url}",
                            "${workflow_input.changeset_url}"
                        ],
                        "output_path": "${tasks.get_osw_osm_dataset_blob_folder_zip_path.output.osw_output_path}"
                    },
                    "output_params": {
                        "success": "${data.success}",
                        "message": "${data.message}",
                        "output_path": "${data.output_path}"
                    }
                },
                {
                    "name": "update_osw_db",
                    "task_reference_name": "update_osw_db",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "table": "content.dataset",
                        "where": {
                            "tdei_dataset_id": "${workflow_input.tdei_dataset_id}"
                        },
                        "data": {
                            "dataset_download_url": "${tasks.osw_compression.output.output_path}"
                        }
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}"
                    },
                    "function": "update_table"
                },
                {
                    "name": "osw_extract_load",
                    "task_reference_name": "osw_extract_load",
                    "description": "Load the formatted osw file into the database",
                    "type": "Event",
                    "topic": "temp-request",
                    "input_params": {
                        "tdei_dataset_id": "${workflow_input.tdei_dataset_id}",
                        "file_upload_path": "${workflow_input.dataset_url}",
                        "data_type": "osw"
                    },
                    "output_params": {
                        "success": "${data.success}",
                        "message": "${data.message}"
                    }
                }
            ]
        }
    ],
    "subscriptions": [
        {
            "description": "Subscription for osw validation completion",
            "topic": "temp-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for osw formatting completion",
            "topic": "osw-formatting-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for osw confidence completion",
            "topic": "osw-confidence-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for extract load request completion",
            "topic": "extract-load-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for backend service completion",
            "topic": "backend-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for flex validation completion",
            "topic": "flex-validation-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for pathways validation completion",
            "topic": "pathways-validation-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for dataset zipping completion",
            "topic": "dataset-zip-response",
            "subscription": "res-handler"
        }
    ]
}