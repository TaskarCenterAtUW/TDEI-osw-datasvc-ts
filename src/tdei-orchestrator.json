{
    "workflows": [
        {
            "name": "osw_upload_workflow",
            "description": "Workflow for uploading osw files",
            "workflow_input": {
                "user_id": "${user_id}",
                "tdei_project_group_id": "${tdei_project_group_id}",
                "dataset_url": "${file_upload_path}"
            },
            "tasks": [
                {
                    "name": "osw_validation",
                    "task_reference_name": "osw_upload|validation",
                    "description": "Validate the uploaded osw file",
                    "type": "Event",
                    "topic": "osw-validation-request",
                    "input_params": {
                        "user_id": "${workflow_input.user_id}",
                        "tdei_project_group_id": "${workflow_input.tdei_project_group_id}",
                        "file_upload_path": "${workflow_input.dataset_url}"
                    },
                    "output_params": {
                        "success": "${message.data.success}",
                        "message": "${message.data.message}"
                    }
                },
                {
                    "name": "osw_formatting",
                    "task_reference_name": "osw_upload|formatting",
                    "description": "Format the validated osw file",
                    "type": "Event",
                    "topic": "osw-formatting-request",
                    "input_params": {
                        "user_id": "${workflow_input.user_id}",
                        "tdei_project_group_id": "${workflow_input.tdei_project_group_id}",
                        "file_upload_path": "${workflow_input.dataset_url}"
                    },
                    "output_params": {
                        "success": "${message.data.success}",
                        "message": "${message.data.message}",
                        "formatted_file_path": "${message.data.formatted_url}"
                    }
                },
                {
                    "name": "workflow_helper",
                    "task_reference_name": "decodeUrl",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "url": "${workflow_input.osw_formatting.output.formatted_url}"
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}",
                        "url": "${url}"
                    },
                    "function": "decodeUrl"
                },
                {
                    "name": "workflow_helper",
                    "task_reference_name": "update_table",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "table_name": "content.dataset",
                        "condition": "tdei_dataset_id = ${workflow_input.tdei_dataset_id}",
                        "update_expression": "osm_url = ${workflow_input.decodeUrl.output.url}"
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}"
                    },
                    "function": "update_table"
                },
                {
                    "name": "workflow_helper",
                    "task_reference_name": "osw_upload_getPathDirectory",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "url": "${workflow_input.inut.dataset_url}"
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}",
                        "path": "${path}"
                    },
                    "function": "getPathDirectory"
                },
                {
                    "name": "osw_compression",
                    "task_reference_name": "osw_upload|osm_compression",
                    "description": "Compress the uploaded osw file",
                    "type": "Event",
                    "topic": "osw-compression-request",
                    "input_params": {
                        "isOsm": true,
                        "input_urls": [
                            "${workflow_input.decodeUrl.output.url}",
                            "${workflow_input.metadata_url}",
                            "${workflow_input.changeset_url}"
                        ],
                        "output_path": "${workflow_input.osw_upload_getPathDirectory.output.path}"
                    },
                    "output_params": {
                        "success": "${message.data.success}",
                        "message": "${message.data.message}",
                        "output_path": "${message.data.output_path}"
                    }
                },
                {
                    "name": "workflow_helper",
                    "task_reference_name": "update_dataset_osm_download_url",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "table_name": "content.dataset",
                        "condition": "tdei_dataset_id = ${workflow_input.tdei_dataset_id}",
                        "update_expression": "dataset_osm_download_url = ${workflow_input.update_dataset_osm_download_url.output.output_path}"
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}"
                    },
                    "function": "update_table"
                },
                {
                    "name": "osw_compression",
                    "task_reference_name": "osw_upload|osw_compression",
                    "description": "Compress the uploaded osw file",
                    "type": "Event",
                    "topic": "osw-compression-request",
                    "input_params": {
                        "isOsm": false,
                        "input_urls": [
                            "${workflow_input.latest_dataset_url}",
                            "${workflow_input.metadata_url}",
                            "${workflow_input.changeset_url}"
                        ],
                        "output_params": {
                            "success": "${message.data.success}",
                            "message": "${message.data.message}",
                            "output_path": "${message.data.output_path}"
                        }
                    }
                },
                {
                    "name": "workflow_helper",
                    "task_reference_name": "osw_upload_update_osm_url",
                    "description": "Helper task to decode the formatted osw file url",
                    "type": "Utility",
                    "input_params": {
                        "table_name": "content.dataset",
                        "condition": "tdei_dataset_id = ${workflow_input.tdei_dataset_id}",
                        "update_expression": "osm_url = ${workflow_input.osw_compression2.output.output_path}"
                    },
                    "output_params": {
                        "success": "${success}",
                        "message": "${message}"
                    },
                    "function": "update_table"
                },
                {
                    "name": "extract_load",
                    "task_reference_name": "osw_upload|extract_load",
                    "description": "Load the formatted osw file into the database",
                    "type": "Event",
                    "topic": "extract-load-request",
                    "input_params": {
                        "tdei_dataset_id": "${workflow_input.tdei_dataset_id}",
                        "file_upload_path": "${workflow_input.dataset_url}",
                        "data_type": "osw"
                    },
                    "output_params": {
                        "success": "${message.data.success}",
                        "message": "${message.data.message}"
                    }
                }
            ]
        }
    ],
    "subscriptions": [
        {
            "description": "Subscription for osw validation completion",
            "topic": "osw-validation-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for osw formatting completion",
            "topic": "osw-formatting-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for osw confidence completion",
            "topic": "osw-confidence-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for extract load request completion",
            "topic": "extract-load-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for backend service completion",
            "topic": "backend-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for flex validation completion",
            "topic": "flex-validation-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for pathways validation completion",
            "topic": "pathways-validation-response",
            "subscription": "res-handler"
        },
        {
            "description": "Subscription for dataset zipping completion",
            "topic": "dataset-zip-response",
            "subscription": "res-handler"
        }
    ]
}